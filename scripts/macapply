#!/bin/bash
#
# macapply - Apply full configuration to current Mac
#
# Usage:
#   macapply              # Full run
#   macapply --tags dock  # Only specific tags
#
# This script applies the full Mac configuration (plays/full.yml)
# Use this after making configuration changes to apply them to your Mac.
#
# For daily updates, use: macupdate
# For initial setup of a NEW Mac, use: init.sh
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log() {
    echo -e "${GREEN}[macapply]${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}[macapply]${NC} $*"
}

log_error() {
    echo -e "${RED}[macapply]${NC} $*"
}

# Script directory and repo
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Configuration
VENV_NAME="mac-dev-playbook-venv"
HOSTNAME=$(hostname -s)

# Parse command line arguments
ANSIBLE_ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --tags)
            ANSIBLE_ARGS+=("--tags" "$2")
            shift 2
            ;;
        --skip-tags)
            ANSIBLE_ARGS+=("--skip-tags" "$2")
            shift 2
            ;;
        --check)
            ANSIBLE_ARGS+=("--check")
            shift
            ;;
        --diff)
            ANSIBLE_ARGS+=("--diff")
            shift
            ;;
        -v|-vv|-vvv)
            ANSIBLE_ARGS+=("$1")
            shift
            ;;
        --help)
            cat << EOF
Usage: macapply [OPTIONS]

Apply full Mac configuration (plays/full.yml) to the current Mac.
Use this after making configuration changes.

Options:
  --tags TAGS        Only run plays and tasks tagged with these values
  --skip-tags TAGS   Skip plays and tasks tagged with these values
  --check            Don't make changes, just show what would change
  --diff             Show differences for changed files
  -v, -vv, -vvv      Increase verbosity
  --help             Show this help message

Examples:
  macapply                    # Apply full configuration
  macapply --tags homebrew    # Only update Homebrew packages
  macapply --tags dock,osx    # Only update Dock and macOS settings
  macapply --check --diff     # Dry run showing what would change

Available tags:
  homebrew, dotfiles, mas, dock, sudoers, terminal, osx, fonts,
  extra-packages, sublime-text, post

For daily updates (brew, system, etc.), use: macupdate
For initial setup of a NEW Mac, use: init.sh
EOF
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Header
log "========================================"
log "macapply - Apply Mac Configuration"
log "========================================"
log "Repository: ${REPO_DIR}"
log "Hostname: ${HOSTNAME}"
if [[ ${#ANSIBLE_ARGS[@]} -gt 0 ]]; then
    log "Options: ${ANSIBLE_ARGS[*]}"
fi
log "========================================"
echo ""

# Setup Python environment (lightweight: just activate existing venv)
# For full setup (install Python, create venv, etc.), use 'macupdate' instead
# shellcheck source=scripts/lib/python-env.sh
source "${SCRIPT_DIR}/lib/python-env.sh"
if ! setup_python_env; then
    exit 1
fi

# Check if Ansible is available
if ! command -v ansible-playbook &> /dev/null; then
    log_error "ansible-playbook not found in current environment"
    log "Please run 'macupdate' first to install Ansible"
    exit 1
fi

log "Using Ansible: $(ansible-playbook --version | head -n1)"
echo ""

# Change to repo directory
cd "${REPO_DIR}" || exit 1

# Vault password is configured in ansible.cfg (vault_password_file = ~/bin/vault_password_mac_dev_playbook)
# The script is auto-deployed from template in plays/full.yml
log "Vault password will be read from 1Password via ansible.cfg"

# Bootstrap: Create vault password script if it doesn't exist (chicken-egg problem)
# This script is needed BEFORE ansible-playbook runs, but is normally deployed BY the playbook
# Note: init.sh creates a dummy version during Phase 1, then deletes it afterward
VAULT_SCRIPT="${HOME}/bin/vault_password_mac_dev_playbook"
if [[ ! -f "${VAULT_SCRIPT}" ]]; then
    log "Creating vault password script (first run)..."

    # Read the 1Password reference from group_vars
    ONEPASSWORD_LINE=$(grep "onepassword_vault_password_ref:" \
        "${REPO_DIR}/inventories/group_vars/macs/onepassword.yml")
    ONEPASSWORD_VAULT_REF=$(echo "${ONEPASSWORD_LINE}" | sed 's/.*: "\(.*\)"/\1/')

    if [[ -z "${ONEPASSWORD_VAULT_REF}" ]]; then
        log_error "Failed to read 1Password vault reference from onepassword.yml"
        exit 1
    fi

    # Create the script
    mkdir -p "${HOME}/bin"
    cat > "${VAULT_SCRIPT}" <<EOF
#!/bin/bash
# Ansible Vault Password Script for mac-dev-playbook
# Auto-generated by macapply - will be updated by plays/full.yml from template

ONEPASSWORD_VAULT_REF="${ONEPASSWORD_VAULT_REF}"
op read "\${ONEPASSWORD_VAULT_REF}"
EOF
    chmod 700 "${VAULT_SCRIPT}"
    log "✓ Vault password script created: ${VAULT_SCRIPT}"
else
    log "✓ Vault password script exists: ${VAULT_SCRIPT}"
fi
echo ""

# Check if host_vars exists
HOST_VARS_FILE="${REPO_DIR}/inventories/host_vars/${HOSTNAME}.yml"
if [[ ! -f "${HOST_VARS_FILE}" ]]; then
    log_error "No host configuration found: ${HOST_VARS_FILE}"
    log "Please create this file first (see docs/NEW_MAC_SETUP.md)"
    exit 1
fi

log "Starting playbook run..."
echo ""

# Run the playbook
if ansible-playbook plays/full.yml \
    -i inventories \
    -l "${HOSTNAME}" \
    --connection=local \
    "${ANSIBLE_ARGS[@]}"; then

    echo ""
    log "========================================"
    log "✓ Configuration applied successfully!"
    log "========================================"
else
    exit_code=$?
    echo ""
    log_error "========================================"
    log_error "Configuration failed (exit code: ${exit_code})"
    log_error "========================================"
    exit "${exit_code}"
fi
