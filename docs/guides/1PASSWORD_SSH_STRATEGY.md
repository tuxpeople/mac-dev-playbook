# 1Password SSH Agent Integration - Strategie

**Erstellt**: 2025-10-22
**Context**: Du verwendest 1Password mit SSH Agent Support

---

## üéØ Aktuelle Situation vs. Bessere L√∂sung

### Aktuell im Playbook

**Was passiert jetzt**:
```yaml
# roles/ansible-mac-update/tasks/ssh.yaml
- name: Update SSH Keys
  ansible.builtin.copy:
    src: "{{ssh_keys_src}}/"  # Von iCloudDrive
    dest: "{{myhomedir}}/.ssh/"
    remote_src: "true"
```

**Problem**:
- SSH Keys werden aus iCloud kopiert
- Keys liegen dann auf dem Filesystem
- Duplikation (iCloud + lokales Filesystem + 1Password)
- Security Risk: Keys in mehreren Locations

### Mit 1Password SSH Agent

**Was m√∂glich ist**:
- SSH Keys nur in 1Password speichern
- 1Password SSH Agent managed die Keys
- Keine Keys auf dem Filesystem n√∂tig
- Biometric Auth f√ºr SSH Operations

---

## üìã Analyse: Was du brauchst

### Szenario 1: Neuer Mac (Initial Setup)

**Ohne 1Password SSH Agent**:
1. ‚ùå Manuell SSH Keys aus 1Password exportieren
2. ‚ùå Keys nach `~/.ssh/` kopieren
3. ‚ùå Permissions setzen
4. ‚ùå In SSH Agent laden

**Mit 1Password SSH Agent**:
1. ‚úÖ 1Password installieren & einloggen
2. ‚úÖ SSH Agent in 1Password aktivieren
3. ‚úÖ SSH Config updaten um 1Password zu nutzen
4. ‚úÖ **Fertig!** Keine Keys kopieren n√∂tig

### Szenario 2: Daily Use / Updates

**Ohne 1Password SSH Agent**:
- ‚ùå Keys m√ºssen synchronisiert bleiben (iCloud ‚Üî lokales Filesystem)
- ‚ùå Update Playbook kopiert Keys bei jedem Run

**Mit 1Password SSH Agent**:
- ‚úÖ Keys nur in 1Password
- ‚úÖ Kein Copy n√∂tig
- ‚úÖ Update Playbook kann SSH Key Management √ºberspringen

---

## üîß Empfohlene Strategie

### Phase 1: Pr√ºfen was du hast

```bash
# 1. Pr√ºfe ob 1Password SSH Agent l√§uft:
echo $SSH_AUTH_SOCK
# Sollte zeigen: ~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock

# 2. Liste SSH Keys in 1Password:
ssh-add -l
# Sollte Keys von 1Password zeigen

# 3. Pr√ºfe SSH Config:
cat ~/.ssh/config | grep -A 5 "IdentityAgent"
```

### Phase 2: Entscheiden welche Keys wo

Du hast vermutlich:

**SSH Keys in 1Password** (vermutlich):
- GitHub Key
- Server Keys
- Deploy Keys

**SSH Keys aktuell im Filesystem** (`~/.ssh/`):
- M√∂glicherweise die gleichen?
- Oder alte/redundante Keys?

**SSH Keys in iCloud** (`~/iCloudDrive/Allgemein/dotfiles/ssh_keys`):
- Backup?
- Sync zwischen Macs?

---

## üéØ Drei Strategien zur Auswahl

### Strategie A: **Full 1Password** (EMPFOHLEN f√ºr neue Setups)

**Konzept**: Alle SSH Keys nur in 1Password, nichts auf Filesystem

**Vorteile**:
- ‚úÖ Maximale Security (Biometric Auth)
- ‚úÖ Keine Keys auf Disk
- ‚úÖ Automatisches Sync zwischen Macs via 1Password
- ‚úÖ Einfachste L√∂sung

**Nachteile**:
- ‚ö†Ô∏è Ben√∂tigt 1Password CLI f√ºr Ansible Automation
- ‚ö†Ô∏è Initial Setup n√∂tig auf jedem Mac

**Ansible Changes**:
```yaml
# SSH Key Copy Task wird √úBERSPRUNGEN
- name: Update SSH Keys
  ansible.builtin.copy:
    src: "{{ssh_keys_src}}/"
    dest: "{{myhomedir}}/.ssh/"
  when: false  # Deaktiviert - nutzen 1Password SSH Agent
```

**SSH Config**:
```ssh
# ~/.ssh/config
Host *
    IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
    # Alle Keys kommen von 1Password
```

---

### Strategie B: **Hybrid** (F√ºr Transition)

**Konzept**: 1Password f√ºr pers√∂nliche Keys, Filesystem f√ºr spezielle Keys

**Use Case**:
- Pers√∂nliche GitHub/GitLab Keys ‚Üí 1Password
- Server Deploy Keys ‚Üí Filesystem (falls rotation n√∂tig)
- Legacy Keys ‚Üí Filesystem

**Ansible Changes**:
```yaml
# Conditional SSH Key Copy
- name: Check if we should use filesystem SSH keys
  set_fact:
    use_filesystem_ssh_keys: "{{ use_1password_ssh_agent | default(true) == false }}"

- name: Update SSH Keys (only if not using 1Password)
  ansible.builtin.copy:
    src: "{{ssh_keys_src}}/"
    dest: "{{myhomedir}}/.ssh/"
    remote_src: "true"
  when: use_filesystem_ssh_keys
  no_log: true
```

**SSH Config**:
```ssh
# ~/.ssh/config
Host *
    IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

# Spezielle Hosts mit Filesystem Keys:
Host legacy-server.com
    IdentityFile ~/.ssh/id_rsa_legacy
    IdentityAgent none  # Nutze normalen SSH Agent
```

---

### Strategie C: **iCloud Backup, 1Password Primary** (BESTE BALANCE)

**Konzept**:
- 1Password SSH Agent f√ºr daily use
- iCloud hat Backup der Keys (f√ºr Notfall)
- Ansible kopiert Keys nur bei Initial Setup

**Vorteile**:
- ‚úÖ 1Password Convenience im daily use
- ‚úÖ iCloud Backup falls 1Password Problem
- ‚úÖ Initial Setup automatisiert

**Ansible Changes**:
```yaml
# In group_vars:
use_1password_ssh_agent: true  # Default
initial_setup_mode: false      # Wird zu true bei fresh setup

# SSH Task:
- name: Update SSH Keys (only during initial setup)
  ansible.builtin.copy:
    src: "{{ssh_keys_src}}/"
    dest: "{{myhomedir}}/.ssh/"
    remote_src: "true"
  when:
    - not use_1password_ssh_agent or initial_setup_mode
    - ssh_keys_src_stat.stat.exists
  no_log: true
```

---

## üõ†Ô∏è Implementation f√ºr Strategie C (Empfehlung)

### 1. SSH Config Setup

**Erstelle**: `files/ssh_config_1password`
```ssh
# 1Password SSH Agent Configuration
Host *
    # Use 1Password SSH Agent
    IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

    # Fallback auf standard SSH agent falls 1Password nicht l√§uft
    # (macOS l√§dt automatisch keys aus ~/.ssh/ in standard agent)
    AddKeysToAgent yes
    UseKeychain yes
```

### 2. Ansible Task Updates

**√Ñndere** `roles/ansible-mac-update/tasks/ssh.yaml`:

```yaml
---
- name: Ensure .ssh folder exists
  file:
    path: "{{myhomedir}}/.ssh"
    state: directory
    mode: '0700'
  become: false

# SSH Config Management
- name: Check if SSH config exists
  ansible.builtin.stat:
    path: "{{myhomedir}}/.ssh/config"
  register: ssh_config_stat

- name: Backup existing SSH config
  ansible.builtin.copy:
    src: "{{myhomedir}}/.ssh/config"
    dest: "{{myhomedir}}/.ssh/config.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    mode: '0600'
  when: ssh_config_stat.stat.exists
  become: false

- name: Find SSH config fragments
  ansible.builtin.find:
    paths: "{{ ssh_config_src }}"
    patterns: "*"
  register: ssh_config_fragments
  failed_when: false

- name: Build SSH config from fragments
  ansible.builtin.assemble:
    src: "{{ ssh_config_src }}"
    dest: "{{myhomedir}}/.ssh/config"
    mode: '0600'
  become: false
  when: ssh_config_fragments.matched > 0

- name: Add 1Password SSH Agent configuration to SSH config
  ansible.builtin.blockinfile:
    path: "{{myhomedir}}/.ssh/config"
    marker: "# {mark} 1PASSWORD SSH AGENT"
    block: |
      # 1Password SSH Agent Configuration
      Host *
          IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
          AddKeysToAgent yes
          UseKeychain yes
    create: yes
    mode: '0600'
  become: false
  when: use_1password_ssh_agent | default(true)

# SSH Keys Management
- name: Check if SSH keys source directory exists
  ansible.builtin.stat:
    path: "{{ ssh_keys_src }}"
  register: ssh_keys_src_stat

- name: Check if this is initial setup (no SSH keys present yet)
  ansible.builtin.find:
    paths: "{{myhomedir}}/.ssh"
    patterns: "id_*"
    excludes: "*.pub"
    file_type: file
  register: existing_ssh_keys

- name: Update SSH Keys (only if needed)
  ansible.builtin.copy:
    src: "{{ssh_keys_src}}/"
    dest: "{{myhomedir}}/.ssh/"
    remote_src: "true"
    mode: preserve
  become: false
  when:
    - ssh_keys_src_stat.stat.exists
    - (existing_ssh_keys.matched == 0) or (force_ssh_key_update | default(false))
  no_log: true

- name: Find SSH private keys
  ansible.builtin.find:
    paths: "{{myhomedir}}/.ssh"
    patterns: "id_*"
    excludes: "*.pub"
    file_type: file
  register: ssh_private_keys_found
  become: false

- name: Fix permissions of SSH private keys
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ ansible_user }}"
    group: staff
    mode: '0600'
  loop: "{{ ssh_private_keys_found.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  no_log: true
  when: ssh_private_keys_found.matched > 0

- name: Find SSH public keys
  ansible.builtin.find:
    paths: "{{myhomedir}}/.ssh"
    patterns: "id_*.pub"
    file_type: file
  register: ssh_public_keys_found
  become: false

- name: Fix permissions of SSH public keys
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ ansible_user }}"
    group: staff
    mode: '0644'
  loop: "{{ ssh_public_keys_found.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when: ssh_public_keys_found.matched > 0
```

### 3. Group Vars Konfiguration

**F√ºge zu** `inventories/group_vars/macs/general.yml`:

```yaml
# 1Password SSH Agent Configuration
use_1password_ssh_agent: true

# Force SSH key update from iCloud (set to true for one-time sync)
force_ssh_key_update: false
```

---

## üìñ Workflow mit 1Password

### Neuer Mac Setup

```bash
# 1. Mac Setup Wizard durchlaufen
# 2. 1Password installieren (via Homebrew im Playbook)
brew install --cask 1password

# 3. 1Password einloggen & SSH Agent aktivieren
# ‚Üí 1Password ‚Üí Settings ‚Üí Developer ‚Üí SSH Agent aktivieren

# 4. Initial Playbook Run
ansible-playbook plays/full.yml -i inventories -l $(hostname) --connection=local

# 5. Verify SSH Agent
ssh-add -l
# Sollte Keys von 1Password zeigen

# 6. Test
ssh -T git@github.com
# Sollte mit 1Password Biometric Auth funktionieren
```

### Daily Updates

```bash
# Normal update run
ansible-playbook plays/update.yml -i inventories -l $(hostname) --connection=local

# SSH Keys werden NICHT kopiert (weil bereits vorhanden oder in 1Password)
# Nur SSH Config wird aktualisiert
```

### Wenn du Keys syncen willst (einmalig)

```bash
# Force SSH keys update from iCloud:
ansible-playbook plays/update.yml -i inventories -l $(hostname) --connection=local \
  -e "force_ssh_key_update=true"
```

---

## üîç Pr√ºfung: Welche Keys hast du wo?

### Schritt 1: Inventory machen

```bash
echo "=== 1Password SSH Keys ==="
# 1Password app ‚Üí SSH Keys section
# Oder via CLI:
op item list --categories "SSH Key" 2>/dev/null || echo "1Password CLI nicht installiert"

echo ""
echo "=== Filesystem SSH Keys (aktuell) ==="
ls -la ~/.ssh/id_* 2>/dev/null || echo "Keine Keys im Filesystem"

echo ""
echo "=== iCloud SSH Keys ==="
ls -la ~/iCloudDrive/Allgemein/dotfiles/ssh_keys/ 2>/dev/null || echo "iCloud Pfad nicht gefunden"

echo ""
echo "=== SSH Agent Status ==="
echo "SSH_AUTH_SOCK: $SSH_AUTH_SOCK"
ssh-add -l 2>/dev/null || echo "Keine Keys im SSH Agent"
```

### Schritt 2: Entscheidung

**Wenn Keys in 1Password sind**:
‚Üí Strategie C implementieren (1Password primary, iCloud backup)

**Wenn Keys NICHT in 1Password sind**:
‚Üí Zuerst Keys in 1Password importieren, dann Strategie C

**Wenn du unsicher bist**:
‚Üí Erstmal nichts √§ndern, Status Quo beibehalten

---

## üéØ Empfehlung f√ºr dich

Basierend auf: "Ich h√§tte 1Password inkl. SSH Agent"

### Sofort:

1. **Pr√ºfe** welche Keys du wo hast (Script oben)

2. **Wenn Keys in 1Password sind**:
   - ‚úÖ Implementiere Strategie C
   - ‚úÖ SSH Config bekommt 1Password Agent
   - ‚úÖ Filesystem Keys sind Fallback
   - ‚úÖ iCloud bleibt als Backup

3. **Wenn Keys NICHT in 1Password sind**:
   - Importiere sie zuerst in 1Password
   - Dann Strategie C implementieren

### Mittelfristig:

Nach erfolgreicher Umstellung:
- Filesystem Keys k√∂nnen gel√∂scht werden (optional)
- iCloud bleibt als Cold Backup
- Daily Use: 100% 1Password

---

## üîí Security Vergleich

| Aspekt | iCloud Copy | 1Password SSH Agent |
|--------|-------------|---------------------|
| Keys auf Disk | ‚ùå Ja | ‚úÖ Nein |
| Biometric Auth | ‚ùå Nein | ‚úÖ Ja (Touch ID) |
| Phishing-sicher | ‚ö†Ô∏è Nein | ‚úÖ Ja |
| Sync zwischen Macs | ‚úÖ Ja | ‚úÖ Ja (besser) |
| Offline Access | ‚úÖ Ja | ‚ö†Ô∏è Braucht 1Password |
| Audit Log | ‚ùå Nein | ‚úÖ Ja |
| Expiry/Rotation | ‚ùå Nein | ‚úÖ Ja |

---

## üìù N√§chster Schritt f√ºr dich

**Bitte teste erst**:
```bash
# Check ob 1Password SSH Agent l√§uft:
echo $SSH_AUTH_SOCK

# Sollte zeigen:
# ~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock
```

**Wenn JA**:
‚Üí Ich kann die Strategie C Implementation machen

**Wenn NEIN**:
‚Üí Zuerst 1Password SSH Agent aktivieren, dann Implementation

Was zeigt der Check bei dir?
