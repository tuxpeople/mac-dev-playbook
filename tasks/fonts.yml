---
# Font Installation Tasks
# Two approaches:
# 1. Downloaded fonts (Basisschrift, Hack) - legacy approach
# 2. File-based fonts (common, private, licensed) - new flexible system

# ============================================================================
# PART 1: Downloaded Fonts (legacy)
# ============================================================================
# https://dev.to/waylonwalker/installing-system-nerd-fonts-with-ansible-35kh

- name: Basisschrift exists
  ansible.builtin.shell: "ls {{ lookup('env', 'HOME') }}/Library/Fonts/DCH-Basisschrift.*"
  register: basisschrift_exists
  changed_when: false
  failed_when: false
  become: false

- name: Download Basisschrift
  when: basisschrift_exists is failed
  ansible.builtin.unarchive:
    src: https://www.basisschrift.ch/sites/default/files/DCH-Basisschrift.otf.zip
    dest: "{{ lookup('env', 'HOME') }}/Library/Fonts/"
    remote_src: true
  become: false
  register: rebuild_fontcache

- name: Hack exists
  ansible.builtin.shell: "ls {{ lookup('env', 'HOME') }}/Library/Fonts/HackNerdFont*"
  register: hack_exists
  changed_when: false
  failed_when: false
  become: false

- name: Download Hack
  when: hack_exists is failed
  ansible.builtin.unarchive:
    src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/Hack.zip
    dest: "{{ lookup('env', 'HOME') }}/Library/Fonts/"
    remote_src: true
  become: false
  register: rebuild_fontcache

# ============================================================================
# PART 2: File-based Fonts (new system)
# ============================================================================

- name: Import file-based font installation tasks
  ansible.builtin.import_tasks: post/fonts.yml
  when: configure_fonts | default(false)

# ============================================================================
# Font Cache Rebuild
# ============================================================================

- name: Rebuild Fontcache
  ansible.builtin.shell: "atsutil databases -removeUser; atsutil server -shutdown; atsutil server -ping; rm -rf  {{ lookup('env', 'HOME') }}/Library/Containers/com.microsoft.*/Data/Library/Application\\ Support/Microsoft/FontCache"
  when: rebuild_fontcache.changed
  changed_when: true
  failed_when: false
  become: false
