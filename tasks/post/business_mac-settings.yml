---
- name: Ensure iCloudDrive symlink exists
  ansible.builtin.file:
    src: "{{ myhomedir }}/Library/Mobile Documents/com~apple~CloudDocs/Dateien"
    dest: "{{ myhomedir }}/iCloudDrive"
    state: link
    force: true
  become: false
  ignore_errors: true  # May not exist if iCloud not synced yet

- name: Check if iCloudDrive source directory exists
  ansible.builtin.stat:
    path: "{{myhomedir}}/iCloudDrive/Allgemein/apps"
  register: icloud_apps_dir

- name: Debug iCloud paths (only when debugging enabled)
  ansible.builtin.debug:
    msg:
      - "iCloudDrive apps dir exists: {{ icloud_apps_dir.stat.exists | default(false) }}"
      - "Expected path: {{myhomedir}}/iCloudDrive/Allgemein/apps"
  when: false  # Set to true for debugging

- name: Copy business apps from iCloudDrive
  ansible.builtin.command:
    cmd: cp -R "{{myhomedir}}/iCloudDrive/Allgemein/apps/{{ business_app }}" "/Applications/"
  become: false
  loop:
    - "Open Umb.app"
    - "Vertec.app"
  loop_control:
    loop_var: business_app
    label: "{{ business_app }}"
  when:
    - icloud_apps_dir.stat.exists
  args:
    creates: "/Applications/{{ business_app }}"  # Make idempotent - only copy if not exists
  changed_when: true  # Report as changed when app is copied (creates parameter handles idempotence)

# https://www.jamf.com/jamf-nation/discussions/12302/active-directory-q-a
- name: Set DSBindTimeout to 4
  ansible.builtin.shell: "/usr/bin/defaults write /Library/Preferences/com.apple.loginwindow DSBindTimeout -int 4"
  become: true
  changed_when: true

- name: Check if Teams backgrounds source directory exists
  ansible.builtin.stat:
    path: "{{myhomedir}}/iCloudDrive/Multimedia/Backgrounds/Teams/"
  register: teams_backgrounds_src
  changed_when: false

- name: Install Teams backgrounds
  ansible.builtin.copy:
    src: "{{myhomedir}}/iCloudDrive/Multimedia/Backgrounds/Teams/"
    dest: "{{ myhomedir }}/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads/"
    mode: 0640
    remote_src: "true"
  become: false
  when:
    - teams_backgrounds_src.stat.exists
    - teams_backgrounds_src.stat.isdir

# Login Items Management
- name: Get current Login Items
  ansible.builtin.shell: |
    osascript -e 'tell application "System Events" to get the name of every login item'
  register: current_login_items
  changed_when: false
  become: false
  failed_when: false  # OK if System Events not accessible

- name: Remove unwanted Login Items
  ansible.builtin.shell: |
    osascript -e 'tell application "System Events" to delete login item "{{ login_item }}"'
  loop: "{{ login_items_to_remove | default([]) }}"
  loop_control:
    loop_var: login_item
    label: "{{ login_item }}"
  when:
    - current_login_items.rc == 0
    - login_item in current_login_items.stdout
  become: false
  changed_when: true  # Always report as changed if we attempt removal
