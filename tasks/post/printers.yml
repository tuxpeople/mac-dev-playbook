---
# tasks/post/printers.yml
# Manages printer installation and configuration on macOS using CUPS/lpadmin

- name: Printer Management
  when: configure_printers | default(false) | bool
  block:
    - name: Get list of currently installed printers
      ansible.builtin.command: lpstat -p
      register: installed_printers
      changed_when: false
      failed_when: false

    - name: Add new printers
      ansible.builtin.command: >-
        lpadmin
        -p "{{ printer.name }}"
        -v "{{ printer.uri }}"
        {% if printer.description is defined %}-D "{{ printer.description }}"{% endif %}
        {% if printer.location is defined %}-L "{{ printer.location }}"{% endif %}
        {% if printer.ppd is defined %}-P "{{ printer.ppd }}"{% endif %}
        -o printer-is-shared=false
        -E
      become: true
      loop: "{{ printers }}"
      loop_control:
        loop_var: printer
      when:
        - printer.state | default('present') == 'present'
        - printer.name not in installed_printers.stdout
      register: printer_add_result
      changed_when: printer_add_result.rc == 0
      failed_when: printer_add_result.rc != 0

    - name: Update existing printers (always runs to ensure config is current)
      ansible.builtin.command: >-
        lpadmin
        -p "{{ printer.name }}"
        -v "{{ printer.uri }}"
        {% if printer.description is defined %}-D "{{ printer.description }}"{% endif %}
        {% if printer.location is defined %}-L "{{ printer.location }}"{% endif %}
        {% if printer.ppd is defined %}-P "{{ printer.ppd }}"{% endif %}
        -o printer-is-shared=false
        -E
      become: true
      loop: "{{ printers }}"
      loop_control:
        loop_var: printer
      when:
        - printer.state | default('present') == 'present'
        - printer.name in installed_printers.stdout
      register: printer_update_result
      changed_when: false  # Don't report as changed since we can't detect actual changes
      failed_when: printer_update_result.rc != 0

    - name: Set printer options (idempotent - doesn't report changes)
      ansible.builtin.command: >-
        lpadmin -p "{{ pair.printer }}" -o "{{ pair.option.key }}={{ pair.option.value }}"
      become: true
      vars:
        printer_option_pairs: |
          {% set pairs = [] %}
          {% for printer in printers %}
          {% if (printer.state | default('present')) == 'present' and printer.options is defined %}
          {% for option_key, option_value in printer.options.items() %}
          {% set _ = pairs.append({'printer': printer.name, 'option': {'key': option_key, 'value': option_value}}) %}
          {% endfor %}
          {% endif %}
          {% endfor %}
          {{ pairs }}
      loop: "{{ printer_option_pairs }}"
      loop_control:
        loop_var: pair
      register: printer_options_result
      changed_when: false  # Can't detect if option actually changed
      failed_when: printer_options_result.rc != 0

    - name: Enable printers (idempotent - doesn't report changes)
      ansible.builtin.command: cupsenable "{{ printer.name }}"
      become: true
      loop: "{{ printers }}"
      loop_control:
        loop_var: printer
      when:
        - printer.enabled | default(true)
        - printer.state | default('present') == 'present'
      register: printer_enable_result
      changed_when: false  # Can't detect if printer was already enabled
      failed_when: false

    - name: Accept jobs for printers (idempotent - doesn't report changes)
      ansible.builtin.command: cupsaccept "{{ printer.name }}"
      become: true
      loop: "{{ printers }}"
      loop_control:
        loop_var: printer
      when:
        - printer.enabled | default(true)
        - printer.state | default('present') == 'present'
      register: printer_accept_result
      changed_when: false  # Can't detect if printer was already accepting jobs
      failed_when: false

    - name: Get current default printer
      ansible.builtin.command: lpstat -d
      register: current_default_printer
      changed_when: false
      failed_when: false

    - name: Set default printer (only if different)
      ansible.builtin.command: lpadmin -d "{{ printer.name }}"
      become: true
      loop: "{{ printers }}"
      loop_control:
        loop_var: printer
      when:
        - printer.default | default(false)
        - printer.state | default('present') == 'present'
        - printer.name not in (current_default_printer.stdout | default(''))
      register: default_printer_result
      changed_when: default_printer_result.rc == 0
      failed_when: default_printer_result.rc != 0

    - name: Remove printers
      ansible.builtin.command: lpadmin -x "{{ printer.name }}"
      become: true
      loop: "{{ printers }}"
      loop_control:
        loop_var: printer
      when:
        - printer.state is defined
        - printer.state == 'absent'
        - printer.name in installed_printers.stdout
      register: printer_remove_result
      changed_when: printer_remove_result.rc == 0
      failed_when: printer_remove_result.rc != 0
